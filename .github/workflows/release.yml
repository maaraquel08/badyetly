name: Create Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write
    pull-requests: read

jobs:
    release:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Generate Release Notes
              id: release_notes
              uses: actions/github-script@v7
              with:
                  script: |
                      const { data: releases } = await github.rest.repos.listReleases({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                      });

                      const latestRelease = releases[0];
                      const previousTag = latestRelease ? latestRelease.tag_name : '';

                      const { data: comparison } = await github.rest.repos.compareCommitsWithBasehead({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        basehead: previousTag ? `${previousTag}...${context.ref.replace('refs/tags/', '')}` : context.ref.replace('refs/tags/', ''),
                      });

                      const commits = comparison.commits;
                      const releaseNotes = commits.map(commit => {
                        const message = commit.commit.message.split('\n')[0];
                        return `- ${message} (${commit.sha.substring(0, 7)})`;
                      }).join('\n');

                      return releaseNotes;

            - name: Create Release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ github.ref_name }}
                  release_name: Release ${{ github.ref_name }}
                  body: |
                      ## Changes in this Release

                      ${{ steps.release_notes.outputs.result }}

                      ## Full Changelog

                      **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.release_notes.outputs.previous_tag }}...${{ github.ref_name }}
                  draft: false
                  prerelease: false
